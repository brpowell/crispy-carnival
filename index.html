<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Alchemist's Gambit</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --fire: #e74c3c;
    --water: #3498db;
    --earth: #8b6914;
    --air: #a8e6cf;
    --shadow: #6c3483;
    --light: #f9e547;
    --bg-dark: #0d0d1a;
    --bg-card: #1a1a2e;
    --bg-panel: #16213e;
    --text: #e0d8c8;
    --text-dim: #8a8270;
    --gold: #d4a726;
    --corruption: #8e1b5e;
    --success: #27ae60;
  }

  body {
    font-family: 'Crimson Text', serif;
    background: var(--bg-dark);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    background-image:
      radial-gradient(ellipse at 20% 50%, rgba(108, 52, 131, 0.08) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 20%, rgba(212, 167, 38, 0.06) 0%, transparent 50%);
  }

  /* â”€â”€ Header â”€â”€ */
  header {
    text-align: center;
    padding: 18px 20px 10px;
    border-bottom: 1px solid rgba(212, 167, 38, 0.15);
  }
  header h1 {
    font-family: 'Cinzel', serif;
    font-size: 1.8rem;
    color: var(--gold);
    text-shadow: 0 0 20px rgba(212, 167, 38, 0.3);
    letter-spacing: 3px;
  }
  header .subtitle {
    font-size: 0.95rem;
    color: var(--text-dim);
    font-style: italic;
    margin-top: 2px;
  }

  /* â”€â”€ Layout â”€â”€ */
  #game-container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 14px 16px;
    display: none;
  }

  /* â”€â”€ Top Status Bar â”€â”€ */
  .status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    margin-bottom: 14px;
    flex-wrap: wrap;
  }
  .stat-group {
    display: flex;
    gap: 16px;
    align-items: center;
  }
  .stat {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 1rem;
    background: var(--bg-panel);
    padding: 5px 12px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.06);
  }
  .stat .icon { font-size: 1.15rem; }
  .stat .value { font-family: 'Cinzel', serif; font-weight: 700; }
  .stat-hp .value { color: var(--fire); }
  .stat-floor .value { color: var(--gold); }
  .stat-potions .value { color: var(--success); }
  .stat-corruption .value { color: var(--corruption); }

  /* â”€â”€ Corruption Bar â”€â”€ */
  .corruption-bar-container {
    width: 100%;
    height: 8px;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    margin-bottom: 14px;
    overflow: hidden;
  }
  .corruption-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--corruption), #c0392b);
    border-radius: 8px;
    transition: width 0.6s ease;
  }

  /* â”€â”€ Main Area â”€â”€ */
  .main-area {
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: 14px;
  }

  /* â”€â”€ Brewing Board â”€â”€ */
  .brew-section h2, .hand-section h2, .sidebar h2 {
    font-family: 'Cinzel', serif;
    font-size: 1rem;
    color: var(--gold);
    margin-bottom: 8px;
    letter-spacing: 1px;
  }

  .brew-board {
    display: flex;
    gap: 14px;
    align-items: center;
    justify-content: center;
    min-height: 140px;
    background: var(--bg-panel);
    border-radius: 12px;
    padding: 18px;
    border: 1px solid rgba(212, 167, 38, 0.1);
    position: relative;
  }

  .brew-slot {
    width: 100px;
    height: 140px;
    border: 2px dashed rgba(212, 167, 38, 0.25);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-dim);
    font-size: 0.85rem;
    transition: all 0.3s;
    position: relative;
  }
  .brew-slot.filled {
    border-color: transparent;
  }
  .brew-slot.highlight {
    border-color: var(--gold);
    box-shadow: 0 0 15px rgba(212, 167, 38, 0.2);
  }

  .brew-plus {
    font-size: 2rem;
    color: var(--text-dim);
    font-family: 'Cinzel', serif;
  }

  .brew-result {
    font-size: 1.5rem;
    color: var(--text-dim);
    font-family: 'Cinzel', serif;
  }

  .brew-output {
    width: 100px;
    height: 140px;
    border: 2px solid rgba(212, 167, 38, 0.12);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.85rem;
    color: var(--text-dim);
    text-align: center;
    padding: 6px;
  }

  #brew-btn {
    display: block;
    margin: 12px auto 0;
    padding: 8px 30px;
    font-family: 'Cinzel', serif;
    font-size: 0.95rem;
    background: linear-gradient(135deg, var(--gold), #b8860b);
    color: #1a1a2e;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    letter-spacing: 1px;
    transition: all 0.3s;
  }
  #brew-btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(212, 167, 38, 0.4); }
  #brew-btn:disabled { opacity: 0.35; cursor: default; }

  /* â”€â”€ Hand â”€â”€ */
  .hand-section { margin-top: 14px; }
  .hand {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    min-height: 140px;
    padding: 10px;
    background: var(--bg-panel);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.04);
    align-items: flex-start;
  }

  /* â”€â”€ Card â”€â”€ */
  .card {
    width: 90px;
    height: 130px;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.25s;
    position: relative;
    text-align: center;
    user-select: none;
    border: 2px solid rgba(255,255,255,0.08);
    flex-shrink: 0;
  }
  .card:hover { transform: translateY(-6px); }
  .card.selected {
    transform: translateY(-10px);
    box-shadow: 0 8px 25px rgba(212, 167, 38, 0.5);
    border-color: var(--gold);
  }
  .card .card-icon { font-size: 2rem; }
  .card .card-name {
    font-family: 'Cinzel', serif;
    font-size: 0.7rem;
    margin-top: 4px;
    font-weight: 700;
    letter-spacing: 0.5px;
  }
  .card .card-desc {
    font-size: 0.6rem;
    color: rgba(255,255,255,0.6);
    margin-top: 2px;
    padding: 0 4px;
    line-height: 1.2;
  }

  .card.fire { background: linear-gradient(145deg, #4a1a1a, #2d0f0f); }
  .card.water { background: linear-gradient(145deg, #1a2a4a, #0f1a2d); }
  .card.earth { background: linear-gradient(145deg, #3a2d0a, #2d1f05); }
  .card.air { background: linear-gradient(145deg, #1a3a2e, #0f2d1a); }
  .card.shadow { background: linear-gradient(145deg, #2d1a3a, #1f0f2d); }
  .card.light { background: linear-gradient(145deg, #3a3a1a, #2d2d0f); }
  .card.potion { background: linear-gradient(145deg, #1a3a1a, #0f2d0f); border-color: var(--success); }
  .card.corruption-card {
    background: linear-gradient(145deg, #3a0a2a, #2d051f);
    border-color: var(--corruption);
    cursor: default;
  }
  .card.corruption-card:hover { transform: none; }

  /* â”€â”€ Sidebar â”€â”€ */
  .sidebar {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .event-panel {
    background: var(--bg-panel);
    border-radius: 12px;
    padding: 14px;
    border: 1px solid rgba(255,255,255,0.04);
    min-height: 100px;
  }
  .event-panel h2 { font-size: 0.9rem; }

  .threat-card-display {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    margin-top: 8px;
  }
  .threat-card-display .card {
    cursor: default;
    width: 100px;
    height: 140px;
  }
  .threat-card-display .card:hover { transform: none; }
  .threat-info {
    font-size: 0.85rem;
    text-align: center;
    color: var(--text-dim);
    line-height: 1.4;
  }
  .threat-info strong { color: var(--corruption); }
  .threat-timer {
    font-size: 0.8rem;
    color: var(--corruption);
    font-weight: 600;
  }

  /* â”€â”€ Recipe Book â”€â”€ */
  .recipe-panel {
    background: var(--bg-panel);
    border-radius: 12px;
    padding: 14px;
    border: 1px solid rgba(255,255,255,0.04);
    max-height: 320px;
    overflow-y: auto;
  }
  .recipe-panel h2 { font-size: 0.9rem; }
  .recipe-list { list-style: none; margin-top: 6px; }
  .recipe-list li {
    font-size: 0.78rem;
    padding: 4px 0;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .recipe-list li:last-child { border-bottom: none; }
  .recipe-combo { color: var(--text-dim); }
  .recipe-result { font-weight: 600; }
  .recipe-undiscovered { color: var(--text-dim); font-style: italic; }

  /* â”€â”€ Log â”€â”€ */
  .log-panel {
    background: var(--bg-panel);
    border-radius: 12px;
    padding: 14px;
    border: 1px solid rgba(255,255,255,0.04);
    max-height: 150px;
    overflow-y: auto;
  }
  .log-panel h2 { font-size: 0.9rem; }
  .log-entries { margin-top: 6px; }
  .log-entry {
    font-size: 0.78rem;
    padding: 2px 0;
    color: var(--text-dim);
    border-bottom: 1px solid rgba(255,255,255,0.02);
  }
  .log-entry.good { color: var(--success); }
  .log-entry.bad { color: var(--corruption); }
  .log-entry.info { color: var(--gold); }

  /* â”€â”€ Buttons row â”€â”€ */
  .action-row {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    flex-wrap: wrap;
  }
  .action-btn {
    padding: 7px 18px;
    font-family: 'Cinzel', serif;
    font-size: 0.85rem;
    background: var(--bg-panel);
    color: var(--text);
    border: 1px solid rgba(212, 167, 38, 0.2);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 700;
  }
  .action-btn:hover:not(:disabled) { border-color: var(--gold); background: rgba(212, 167, 38, 0.1); }
  .action-btn:disabled { opacity: 0.35; cursor: default; }
  .action-btn.danger { border-color: rgba(142, 27, 94, 0.3); }
  .action-btn.danger:hover:not(:disabled) { border-color: var(--corruption); background: rgba(142, 27, 94, 0.1); }

  /* â”€â”€ Screens â”€â”€ */
  .screen {
    max-width: 650px;
    margin: 60px auto;
    text-align: center;
    padding: 40px 30px;
    background: var(--bg-panel);
    border-radius: 16px;
    border: 1px solid rgba(212, 167, 38, 0.12);
  }
  .screen h2 {
    font-family: 'Cinzel', serif;
    font-size: 1.8rem;
    color: var(--gold);
    margin-bottom: 18px;
  }
  .screen p {
    font-size: 1.05rem;
    line-height: 1.7;
    margin-bottom: 10px;
    color: var(--text);
  }
  .screen .start-btn {
    display: inline-block;
    margin-top: 22px;
    padding: 12px 40px;
    font-family: 'Cinzel', serif;
    font-size: 1.1rem;
    background: linear-gradient(135deg, var(--gold), #b8860b);
    color: #1a1a2e;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 900;
    letter-spacing: 2px;
    transition: all 0.3s;
  }
  .screen .start-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212, 167, 38, 0.5); }

  .rules-section {
    text-align: left;
    margin: 20px 0;
    padding: 20px;
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
  }
  .rules-section h3 {
    font-family: 'Cinzel', serif;
    font-size: 1rem;
    color: var(--gold);
    margin: 14px 0 6px;
  }
  .rules-section h3:first-child { margin-top: 0; }
  .rules-section p, .rules-section li {
    font-size: 0.92rem;
    line-height: 1.6;
    color: var(--text-dim);
  }
  .rules-section ul { margin-left: 20px; margin-bottom: 6px; }

  /* â”€â”€ Game Over / Win â”€â”€ */
  .overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }
  .overlay.show { display: flex; }
  .overlay-box {
    background: var(--bg-panel);
    border-radius: 16px;
    padding: 40px;
    text-align: center;
    border: 1px solid rgba(212, 167, 38, 0.15);
    max-width: 450px;
  }
  .overlay-box h2 {
    font-family: 'Cinzel', serif;
    font-size: 1.6rem;
    margin-bottom: 12px;
  }
  .overlay-box.win h2 { color: var(--gold); }
  .overlay-box.lose h2 { color: var(--corruption); }
  .overlay-box p { font-size: 1rem; margin-bottom: 16px; color: var(--text-dim); }
  .overlay-box .score { font-family: 'Cinzel', serif; font-size: 1.3rem; color: var(--gold); margin-bottom: 16px; }

  /* â”€â”€ Animations â”€â”€ */
  @keyframes brew-flash {
    0% { box-shadow: 0 0 0 rgba(212, 167, 38, 0); }
    50% { box-shadow: 0 0 40px rgba(212, 167, 38, 0.6); }
    100% { box-shadow: 0 0 0 rgba(212, 167, 38, 0); }
  }
  .brew-flash { animation: brew-flash 0.6s ease; }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }
  .shake { animation: shake 0.4s ease; }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .fade-in { animation: fadeInUp 0.3s ease; }

  /* â”€â”€ Tooltip â”€â”€ */
  .tooltip-host { position: relative; }
  .tooltip-host .tooltip-text {
    display: none;
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    background: #222;
    color: var(--text);
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 0.75rem;
    white-space: nowrap;
    z-index: 50;
    pointer-events: none;
  }
  .tooltip-host:hover .tooltip-text { display: block; }

  /* â”€â”€ Responsive â”€â”€ */
  @media (max-width: 780px) {
    .main-area { grid-template-columns: 1fr; }
    .sidebar { flex-direction: row; flex-wrap: wrap; }
    .sidebar > * { flex: 1 1 220px; }
    .brew-board { flex-wrap: wrap; }
    header h1 { font-size: 1.3rem; }
  }

  /* â”€â”€ Instructions toggle â”€â”€ */
  #instructions-btn {
    position: fixed;
    top: 12px;
    right: 16px;
    z-index: 60;
    background: var(--bg-panel);
    border: 1px solid rgba(212, 167, 38, 0.25);
    color: var(--gold);
    font-family: 'Cinzel', serif;
    font-size: 0.8rem;
    padding: 6px 14px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
  }
  #instructions-btn:hover { background: rgba(212, 167, 38, 0.1); }

  .instructions-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    z-index: 55;
    overflow-y: auto;
    padding: 40px 20px;
  }
  .instructions-overlay.show { display: block; }
  .instructions-content {
    max-width: 650px;
    margin: 0 auto;
    background: var(--bg-panel);
    border-radius: 16px;
    padding: 30px;
    border: 1px solid rgba(212, 167, 38, 0.12);
  }
  .instructions-content h2 {
    font-family: 'Cinzel', serif;
    font-size: 1.4rem;
    color: var(--gold);
    margin-bottom: 16px;
    text-align: center;
  }
  .instructions-close {
    display: block;
    margin: 20px auto 0;
    padding: 8px 24px;
    font-family: 'Cinzel', serif;
    background: var(--gold);
    color: #1a1a2e;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
  }

  .discard-selected {
    outline: 3px solid var(--corruption);
    outline-offset: 2px;
    opacity: 0.7;
  }
</style>
</head>
<body>

<header>
  <h1>The Alchemist's Gambit</h1>
  <p class="subtitle">Brew potions. Banish corruption. Survive the tower.</p>
</header>

<button id="instructions-btn" onclick="toggleInstructions()">How to Play</button>

<!-- Instructions Overlay -->
<div class="instructions-overlay" id="instructions-overlay">
  <div class="instructions-content">
    <h2>How to Play</h2>
    <div class="rules-section">
      <h3>Goal</h3>
      <p>Ascend 10 floors of the Corruption Tower by brewing potions from ingredient cards. Reach the top before corruption overwhelms you!</p>

      <h3>Ingredients</h3>
      <ul>
        <li><strong>Fire</strong> &mdash; Ember essence, volatile and hot</li>
        <li><strong>Water</strong> &mdash; Moonwell drops, cool and flowing</li>
        <li><strong>Earth</strong> &mdash; Ironroot dust, solid and grounding</li>
        <li><strong>Air</strong> &mdash; Zephyr breath, light and swift</li>
        <li><strong>Shadow</strong> &mdash; Voidmist ink, dark and consuming</li>
        <li><strong>Light</strong> &mdash; Starflare mote, bright and purifying</li>
      </ul>

      <h3>Brewing</h3>
      <p>Select two ingredient cards from your hand to place on the brewing board, then press <strong>Brew</strong>. Every pair of elements creates a unique potion with a special effect. Experiment to discover all 15 recipes!</p>

      <h3>Threats</h3>
      <p>Each floor spawns a <strong>Corruption Threat</strong>. Threats have a countdown &mdash; if you don't neutralize them in time, they deal corruption damage. Different potions are effective against different threats.</p>

      <h3>Potion Effects</h3>
      <ul>
        <li><strong>Healing potions</strong> reduce corruption</li>
        <li><strong>Attack potions</strong> deal direct damage to threats</li>
        <li><strong>Shield potions</strong> block incoming corruption damage</li>
        <li><strong>Utility potions</strong> grant extra draws, reduce timers, or reveal recipes</li>
      </ul>

      <h3>Floor Progression</h3>
      <p>Neutralize the current threat to advance to the next floor. Each floor, threats grow stronger and timers grow shorter.</p>

      <h3>Corruption</h3>
      <p>The corruption bar fills as threats damage you. If it reaches 100%, the tower consumes you and the game ends. Heal wisely!</p>

      <h3>Other Actions</h3>
      <ul>
        <li><strong>Draw</strong> &mdash; Draw cards to fill your hand (max 7 cards). You get one free draw per turn, extra draws cost 5 corruption.</li>
        <li><strong>Discard</strong> &mdash; Select cards to discard, then press Discard to clear them and make room.</li>
        <li><strong>End Turn</strong> &mdash; End your turn. Threat timers tick down by 1.</li>
      </ul>

      <h3>Scoring</h3>
      <p>Your score is based on floors cleared, potions brewed, recipes discovered, and remaining health. Aim for the highest score!</p>
    </div>
    <button class="instructions-close" onclick="toggleInstructions()">Got It</button>
  </div>
</div>

<!-- Title Screen -->
<div class="screen" id="title-screen">
  <h2>The Alchemist's Gambit</h2>
  <p>You are an alchemist trapped in the Corruption Tower. Combine elemental ingredients to brew potions, fight off dark threats, and ascend all 10 floors to freedom.</p>
  <div class="rules-section">
    <h3>Quick Start</h3>
    <p>Select two ingredient cards and press <strong>Brew</strong> to create potions. Neutralize threats before their timers run out. Reach Floor 10 to win!</p>
    <h3>Elements</h3>
    <p>Fire, Water, Earth, Air, Shadow, and Light &mdash; every pair creates a unique potion. Discover all 15 recipes to master the tower.</p>
    <h3>Tip</h3>
    <p>Pay attention to what each threat is weak against. The right potion can neutralize a threat instantly!</p>
  </div>
  <button class="start-btn" onclick="startGame()">Enter the Tower</button>
</div>

<!-- Game Container -->
<div id="game-container">
  <!-- Status bar -->
  <div class="status-bar">
    <div class="stat-group">
      <div class="stat stat-floor">
        <span class="icon">å¡”</span>
        <span>Floor</span>
        <span class="value" id="floor-num">1</span>
        <span>/ 10</span>
      </div>
      <div class="stat stat-potions">
        <span class="icon">âš—</span>
        <span>Brewed</span>
        <span class="value" id="potions-brewed">0</span>
      </div>
      <div class="stat stat-potions">
        <span class="icon">ğŸ“–</span>
        <span>Recipes</span>
        <span class="value" id="recipes-found">0</span>
        <span>/ 15</span>
      </div>
    </div>
    <div class="stat-group">
      <div class="stat stat-corruption">
        <span class="icon">â˜ </span>
        <span>Corruption</span>
        <span class="value" id="corruption-val">0</span>
        <span>%</span>
      </div>
      <div class="stat stat-hp">
        <span class="icon">ğŸ›¡</span>
        <span>Shield</span>
        <span class="value" id="shield-val">0</span>
      </div>
    </div>
  </div>

  <!-- Corruption bar -->
  <div class="corruption-bar-container">
    <div class="corruption-bar-fill" id="corruption-bar" style="width: 0%"></div>
  </div>

  <div class="main-area">
    <!-- Left: Brew + Hand -->
    <div>
      <div class="brew-section">
        <h2>Brewing Board</h2>
        <div class="brew-board" id="brew-board">
          <div class="brew-slot" id="brew-slot-0"><span>Slot 1</span></div>
          <div class="brew-plus">+</div>
          <div class="brew-slot" id="brew-slot-1"><span>Slot 2</span></div>
          <div class="brew-result">=</div>
          <div class="brew-output" id="brew-output">?</div>
        </div>
        <button id="brew-btn" disabled onclick="brewPotion()">Brew</button>
      </div>

      <div class="hand-section">
        <h2>Your Hand <span style="font-size:0.8rem; color:var(--text-dim); font-family:'Crimson Text',serif;" id="hand-count">(0/7)</span></h2>
        <div class="hand" id="hand"></div>
      </div>

      <div class="action-row">
        <button class="action-btn" id="draw-btn" onclick="drawCards()">Draw Cards</button>
        <button class="action-btn danger" id="discard-btn" onclick="toggleDiscardMode()">Discard</button>
        <button class="action-btn" id="end-turn-btn" onclick="endTurn()">End Turn</button>
      </div>
    </div>

    <!-- Right: Sidebar -->
    <div class="sidebar">
      <div class="event-panel">
        <h2>Current Threat</h2>
        <div id="threat-display" class="threat-card-display">
          <p class="threat-info" style="color:var(--text-dim)">No threat yet...</p>
        </div>
      </div>

      <div class="recipe-panel">
        <h2>Recipe Book</h2>
        <ul class="recipe-list" id="recipe-list"></ul>
      </div>

      <div class="log-panel">
        <h2>Alchemist's Log</h2>
        <div class="log-entries" id="log-entries"></div>
      </div>
    </div>
  </div>
</div>

<!-- Overlay (game over / win) -->
<div class="overlay" id="overlay">
  <div class="overlay-box" id="overlay-box">
    <h2 id="overlay-title"></h2>
    <p id="overlay-msg"></p>
    <div class="score" id="overlay-score"></div>
    <button class="start-btn" onclick="restartGame()">Play Again</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THE ALCHEMIST'S GAMBIT â€” Game Logic
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Element Definitions â”€â”€
const ELEMENTS = ['fire', 'water', 'earth', 'air', 'shadow', 'light'];
const ELEMENT_DATA = {
  fire:   { name: 'Fire',   icon: 'ğŸ”¥', desc: 'Ember essence' },
  water:  { name: 'Water',  icon: 'ğŸ’§', desc: 'Moonwell drops' },
  earth:  { name: 'Earth',  icon: 'ğŸª¨', desc: 'Ironroot dust' },
  air:    { name: 'Air',    icon: 'ğŸŒ¬', desc: 'Zephyr breath' },
  shadow: { name: 'Shadow', icon: 'ğŸŒ‘', desc: 'Voidmist ink' },
  light:  { name: 'Light',  icon: 'âœ¨', desc: 'Starflare mote' },
};

// â”€â”€ Recipe Definitions (15 unique combos) â”€â”€
function recipeKey(a, b) {
  return [a, b].sort().join('+');
}

const RECIPES = {
  [recipeKey('fire','water')]:   { name: 'Steam Blast',       icon: 'â™¨ï¸',  type: 'attack',  power: 3,  desc: 'Deals 3 damage to threat' },
  [recipeKey('fire','earth')]:   { name: 'Molten Shield',     icon: 'ğŸ›¡',  type: 'shield',  power: 3,  desc: 'Grants 3 shield' },
  [recipeKey('fire','air')]:     { name: 'Inferno Gale',      icon: 'ğŸŒª',  type: 'attack',  power: 4,  desc: 'Deals 4 damage to threat' },
  [recipeKey('fire','shadow')]:  { name: 'Hellfire Tonic',    icon: 'ğŸ‘¹',  type: 'attack',  power: 5,  desc: 'Deals 5 damage to threat' },
  [recipeKey('fire','light')]:   { name: 'Radiant Flame',     icon: 'ğŸŒŸ',  type: 'heal',    power: 8,  desc: 'Reduces corruption by 8' },
  [recipeKey('water','earth')]:  { name: 'Ironbark Salve',    icon: 'ğŸŒ¿',  type: 'heal',    power: 6,  desc: 'Reduces corruption by 6' },
  [recipeKey('water','air')]:    { name: 'Mistform Elixir',   icon: 'ğŸŒ«',  type: 'shield',  power: 4,  desc: 'Grants 4 shield' },
  [recipeKey('water','shadow')]: { name: 'Abyssal Draught',   icon: 'ğŸ«§',  type: 'attack',  power: 4,  desc: 'Deals 4 damage to threat' },
  [recipeKey('water','light')]:  { name: 'Moonbeam Tonic',    icon: 'ğŸŒ™',  type: 'draw',    power: 3,  desc: 'Draw 3 extra cards' },
  [recipeKey('earth','air')]:    { name: 'Dust Devil Brew',   icon: 'ğŸœ',  type: 'attack',  power: 3,  desc: 'Deals 3 damage & grants 1 shield' },
  [recipeKey('earth','shadow')]: { name: 'Gravestone Elixir', icon: 'âš°ï¸',  type: 'shield',  power: 5,  desc: 'Grants 5 shield' },
  [recipeKey('earth','light')]:  { name: 'Terra Lumina',      icon: 'ğŸ’',  type: 'heal',    power: 5,  desc: 'Reduces corruption by 5 & grants 1 shield' },
  [recipeKey('air','shadow')]:   { name: 'Phantom Zephyr',    icon: 'ğŸ‘»',  type: 'weaken',  power: 2,  desc: 'Reduces threat HP by 2 & timer +1' },
  [recipeKey('air','light')]:    { name: 'Skyblessing',       icon: 'â˜€ï¸',  type: 'heal',    power: 10, desc: 'Reduces corruption by 10' },
  [recipeKey('shadow','light')]: { name: 'Eclipse Serum',     icon: 'ğŸŒ—',  type: 'nuke',    power: 7,  desc: 'Deals 7 damage to threat' },
};

// â”€â”€ Threat Definitions â”€â”€
const THREAT_TEMPLATES = [
  { name: 'Corruption Wisp',     icon: 'ğŸ‘', baseHp: 3,  baseDmg: 8,  baseTimer: 4, weakness: 'attack',  desc: 'Weak to attack potions' },
  { name: 'Shadow Wraith',       icon: 'ğŸ’€', baseHp: 4,  baseDmg: 12, baseTimer: 3, weakness: 'heal',    desc: 'Weak to healing light' },
  { name: 'Void Tendril',        icon: 'ğŸ™', baseHp: 5,  baseDmg: 10, baseTimer: 4, weakness: 'shield',  desc: 'Weak to shield potions' },
  { name: 'Dark Sentinel',       icon: 'âš”ï¸', baseHp: 6,  baseDmg: 15, baseTimer: 5, weakness: 'nuke',    desc: 'Only vulnerable to ecliptic force' },
  { name: 'Blight Spore',        icon: 'ğŸ„', baseHp: 3,  baseDmg: 6,  baseTimer: 3, weakness: 'attack',  desc: 'Weak to attack potions' },
  { name: 'Corrupted Golem',     icon: 'ğŸ—¿', baseHp: 7,  baseDmg: 14, baseTimer: 5, weakness: 'attack',  desc: 'Weak to attack potions' },
  { name: 'Hex Phantom',         icon: 'ğŸ­', baseHp: 4,  baseDmg: 10, baseTimer: 3, weakness: 'weaken',  desc: 'Weak to weakening effects' },
  { name: 'Abyssal Maw',         icon: 'ğŸ•³', baseHp: 8,  baseDmg: 18, baseTimer: 5, weakness: 'nuke',    desc: 'Only vulnerable to ecliptic force' },
];

// â”€â”€ Game State â”€â”€
let state = {};

function initState() {
  state = {
    floor: 1,
    corruption: 0,
    shield: 0,
    potionsBrewed: 0,
    recipesDiscovered: new Set(),
    hand: [],
    deck: [],
    brewSlots: [null, null],
    selectedHandIndices: [],
    threat: null,
    turnNumber: 0,
    freeDraw: true,
    discardMode: false,
    discardSelected: new Set(),
    gameOver: false,
  };
}

// â”€â”€ Deck â”€â”€
function buildDeck() {
  const deck = [];
  // 8 of each element = 48 cards
  for (const el of ELEMENTS) {
    for (let i = 0; i < 8; i++) deck.push(el);
  }
  shuffle(deck);
  return deck;
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

// â”€â”€ Draw â”€â”€
function drawCards(count) {
  if (state.gameOver) return;

  if (typeof count !== 'number') {
    // Called from button
    if (state.hand.length >= 7) {
      addLog('Hand is full! Discard some cards first.', 'bad');
      return;
    }
    if (!state.freeDraw) {
      // Costs corruption
      state.corruption = Math.min(100, state.corruption + 5);
      addLog('Spent 5 corruption to draw extra cards.', 'bad');
    }
    state.freeDraw = false;
    count = Math.min(3, 7 - state.hand.length);
  }

  const toDraw = Math.min(count, 7 - state.hand.length);
  for (let i = 0; i < toDraw; i++) {
    if (state.deck.length === 0) {
      state.deck = buildDeck();
      addLog('The deck reshuffles with new ingredients...', 'info');
    }
    state.hand.push(state.deck.pop());
  }
  render();
}

// â”€â”€ Card Selection â”€â”€
function selectHandCard(index) {
  if (state.gameOver) return;

  if (state.discardMode) {
    if (state.discardSelected.has(index)) {
      state.discardSelected.delete(index);
    } else {
      state.discardSelected.add(index);
    }
    render();
    return;
  }

  const idx = state.selectedHandIndices.indexOf(index);
  if (idx !== -1) {
    // Deselect â€” remove from brew slot too
    state.selectedHandIndices.splice(idx, 1);
    state.brewSlots[idx] = null;
    // Re-map remaining
    rebuildBrewSlots();
    render();
    return;
  }

  if (state.selectedHandIndices.length >= 2) return; // Already have 2

  state.selectedHandIndices.push(index);
  rebuildBrewSlots();
  render();
}

function rebuildBrewSlots() {
  state.brewSlots = [null, null];
  for (let i = 0; i < state.selectedHandIndices.length; i++) {
    state.brewSlots[i] = state.hand[state.selectedHandIndices[i]];
  }
}

// â”€â”€ Brewing â”€â”€
function brewPotion() {
  if (state.gameOver) return;
  if (!state.brewSlots[0] || !state.brewSlots[1]) return;

  const key = recipeKey(state.brewSlots[0], state.brewSlots[1]);
  const recipe = RECIPES[key];
  if (!recipe) return;

  // Discover recipe
  const isNew = !state.recipesDiscovered.has(key);
  state.recipesDiscovered.add(key);
  state.potionsBrewed++;

  // Remove cards from hand (higher index first to preserve indices)
  const indices = [...state.selectedHandIndices].sort((a, b) => b - a);
  for (const i of indices) state.hand.splice(i, 1);
  state.selectedHandIndices = [];
  state.brewSlots = [null, null];

  // Apply potion effect
  applyPotion(recipe);

  if (isNew) {
    addLog(`New recipe discovered: ${recipe.icon} ${recipe.name}!`, 'info');
  }
  addLog(`Brewed ${recipe.icon} ${recipe.name}: ${recipe.desc}`, 'good');

  // Flash the brew board
  const board = document.getElementById('brew-board');
  board.classList.add('brew-flash');
  setTimeout(() => board.classList.remove('brew-flash'), 600);

  checkWinLose();
  render();
}

function applyPotion(recipe) {
  const t = state.threat;
  switch (recipe.type) {
    case 'attack': {
      let dmg = recipe.power;
      if (t && t.weakness === 'attack') dmg = Math.ceil(dmg * 1.5);
      if (t) {
        t.hp = Math.max(0, t.hp - dmg);
        addLog(`Dealt ${dmg} damage to ${t.name}!${t.weakness === 'attack' ? ' (Super effective!)' : ''}`, 'good');
        if (t.hp <= 0) threatDefeated();
      }
      break;
    }
    case 'heal': {
      state.corruption = Math.max(0, state.corruption - recipe.power);
      if (state.threat && state.threat.weakness === 'heal') {
        state.threat.hp = Math.max(0, state.threat.hp - 2);
        addLog('The healing light sears the darkness!', 'good');
        if (state.threat.hp <= 0) threatDefeated();
      }
      break;
    }
    case 'shield': {
      let s = recipe.power;
      if (t && t.weakness === 'shield') {
        t.hp = Math.max(0, t.hp - 2);
        addLog('Shield energy repels the threat!', 'good');
        if (t.hp <= 0) threatDefeated();
      }
      state.shield += s;
      break;
    }
    case 'draw': {
      drawCards(recipe.power);
      break;
    }
    case 'weaken': {
      if (t) {
        let dmg = recipe.power;
        if (t.weakness === 'weaken') dmg = Math.ceil(dmg * 2);
        t.hp = Math.max(0, t.hp - dmg);
        t.timer = Math.min(t.timer + 1, 9);
        addLog(`Weakened ${t.name}! Timer extended.${t.weakness === 'weaken' ? ' (Super effective!)' : ''}`, 'good');
        if (t.hp <= 0) threatDefeated();
      }
      break;
    }
    case 'nuke': {
      let dmg = recipe.power;
      if (t && t.weakness === 'nuke') dmg = Math.ceil(dmg * 1.5);
      if (t) {
        t.hp = Math.max(0, t.hp - dmg);
        addLog(`Eclipse devastation: ${dmg} damage!${t.weakness === 'nuke' ? ' (Super effective!)' : ''}`, 'good');
        if (t.hp <= 0) threatDefeated();
      }
      break;
    }
  }

  // Bonus for earth+air: dust devil gives 1 shield too
  if (recipe.name === 'Dust Devil Brew') state.shield += 1;
  // Bonus for earth+light: terra lumina gives 1 shield
  if (recipe.name === 'Terra Lumina') state.shield += 1;
}

function threatDefeated() {
  addLog(`${state.threat.name} has been vanquished!`, 'info');
  state.threat = null;
  advanceFloor();
}

function advanceFloor() {
  if (state.floor >= 10) {
    winGame();
    return;
  }
  state.floor++;
  addLog(`Ascending to Floor ${state.floor}...`, 'info');
  spawnThreat();
}

// â”€â”€ Threats â”€â”€
function spawnThreat() {
  const template = THREAT_TEMPLATES[Math.floor(Math.random() * THREAT_TEMPLATES.length)];
  const scaling = 1 + (state.floor - 1) * 0.15;
  const timerReduction = Math.floor((state.floor - 1) / 3);
  state.threat = {
    name: template.name,
    icon: template.icon,
    hp: Math.ceil(template.baseHp * scaling),
    maxHp: Math.ceil(template.baseHp * scaling),
    dmg: Math.ceil(template.baseDmg * scaling),
    timer: Math.max(2, template.baseTimer - timerReduction),
    maxTimer: Math.max(2, template.baseTimer - timerReduction),
    weakness: template.weakness,
    desc: template.desc,
  };
  addLog(`A ${state.threat.name} ${state.threat.icon} appears! (${state.threat.desc})`, 'bad');
}

// â”€â”€ End Turn â”€â”€
function endTurn() {
  if (state.gameOver) return;
  state.turnNumber++;
  state.freeDraw = true;

  // Tick threat timer
  if (state.threat) {
    state.threat.timer--;
    if (state.threat.timer <= 0) {
      // Threat attacks
      let dmg = state.threat.dmg;
      const shieldAbsorb = Math.min(state.shield, dmg);
      state.shield -= shieldAbsorb;
      dmg -= shieldAbsorb;
      state.corruption = Math.min(100, state.corruption + dmg);
      if (shieldAbsorb > 0) {
        addLog(`Shield absorbed ${shieldAbsorb} corruption!`, 'info');
      }
      addLog(`${state.threat.name} unleashes ${state.threat.dmg} corruption!${dmg > 0 ? ` You take ${dmg}.` : ' Fully blocked!'}`, 'bad');

      // Threat doesn't disappear, it resets timer and keeps attacking
      state.threat.timer = state.threat.maxTimer;
    }
  }

  checkWinLose();
  render();
}

// â”€â”€ Discard Mode â”€â”€
function toggleDiscardMode() {
  if (state.gameOver) return;
  if (state.discardMode) {
    // Execute discard
    if (state.discardSelected.size > 0) {
      const indices = [...state.discardSelected].sort((a, b) => b - a);
      for (const i of indices) state.hand.splice(i, 1);
      addLog(`Discarded ${indices.length} card(s).`, 'info');
    }
    state.discardMode = false;
    state.discardSelected.clear();
    state.selectedHandIndices = [];
    state.brewSlots = [null, null];
  } else {
    state.discardMode = true;
    state.discardSelected.clear();
    state.selectedHandIndices = [];
    state.brewSlots = [null, null];
    addLog('Select cards to discard, then press Discard again.', 'info');
  }
  render();
}

// â”€â”€ Win / Lose â”€â”€
function checkWinLose() {
  if (state.corruption >= 100) {
    loseGame();
  }
}

function winGame() {
  state.gameOver = true;
  const score = calcScore();
  const box = document.getElementById('overlay-box');
  box.className = 'overlay-box win';
  document.getElementById('overlay-title').textContent = 'Tower Conquered!';
  document.getElementById('overlay-msg').textContent = 'You brewed your way to freedom! The corruption fades as sunlight floods the tower.';
  document.getElementById('overlay-score').textContent = `Final Score: ${score}`;
  document.getElementById('overlay').classList.add('show');
}

function loseGame() {
  state.gameOver = true;
  const score = calcScore();
  const box = document.getElementById('overlay-box');
  box.className = 'overlay-box lose';
  document.getElementById('overlay-title').textContent = 'Consumed by Corruption';
  document.getElementById('overlay-msg').textContent = `You fell on Floor ${state.floor}. The tower claims another alchemist...`;
  document.getElementById('overlay-score').textContent = `Final Score: ${score}`;
  document.getElementById('overlay').classList.add('show');
}

function calcScore() {
  let s = 0;
  s += state.floor * 100;
  s += state.potionsBrewed * 25;
  s += state.recipesDiscovered.size * 50;
  s += Math.max(0, 100 - state.corruption) * 2;
  s += state.shield * 5;
  return s;
}

// â”€â”€ Logging â”€â”€
function addLog(msg, cls = '') {
  const entries = document.getElementById('log-entries');
  if (!entries) return;
  const div = document.createElement('div');
  div.className = `log-entry ${cls} fade-in`;
  div.textContent = msg;
  entries.prepend(div);
  // Keep max 50 entries
  while (entries.children.length > 50) entries.removeChild(entries.lastChild);
}

// â”€â”€ Rendering â”€â”€
function render() {
  // Stats
  document.getElementById('floor-num').textContent = state.floor;
  document.getElementById('potions-brewed').textContent = state.potionsBrewed;
  document.getElementById('recipes-found').textContent = state.recipesDiscovered.size;
  document.getElementById('corruption-val').textContent = state.corruption;
  document.getElementById('shield-val').textContent = state.shield;
  document.getElementById('corruption-bar').style.width = state.corruption + '%';

  // Brew slots
  for (let i = 0; i < 2; i++) {
    const slot = document.getElementById(`brew-slot-${i}`);
    if (state.brewSlots[i]) {
      const el = ELEMENT_DATA[state.brewSlots[i]];
      slot.innerHTML = `<div class="card ${state.brewSlots[i]}" style="width:90px;height:126px;cursor:default;pointer-events:none;"><span class="card-icon">${el.icon}</span><span class="card-name">${el.name}</span></div>`;
      slot.classList.add('filled');
    } else {
      slot.innerHTML = `<span>Slot ${i + 1}</span>`;
      slot.classList.remove('filled');
    }
    slot.classList.toggle('highlight', !state.brewSlots[i] && state.selectedHandIndices.length === i);
  }

  // Brew output preview
  const output = document.getElementById('brew-output');
  if (state.brewSlots[0] && state.brewSlots[1]) {
    const key = recipeKey(state.brewSlots[0], state.brewSlots[1]);
    const recipe = RECIPES[key];
    if (recipe) {
      const discovered = state.recipesDiscovered.has(key);
      output.innerHTML = `<span style="font-size:1.5rem">${recipe.icon}</span><br><span style="font-size:0.75rem;${discovered ? '' : 'color:var(--gold)'}">${discovered ? recipe.name : '???'}</span>`;
    }
    document.getElementById('brew-btn').disabled = false;
  } else {
    output.innerHTML = '?';
    document.getElementById('brew-btn').disabled = true;
  }

  // Hand
  const handEl = document.getElementById('hand');
  handEl.innerHTML = '';
  state.hand.forEach((el, i) => {
    const data = ELEMENT_DATA[el];
    const card = document.createElement('div');
    card.className = `card ${el} fade-in`;
    if (state.selectedHandIndices.includes(i)) card.classList.add('selected');
    if (state.discardMode && state.discardSelected.has(i)) card.classList.add('discard-selected');
    card.innerHTML = `<span class="card-icon">${data.icon}</span><span class="card-name">${data.name}</span><span class="card-desc">${data.desc}</span>`;
    card.onclick = () => selectHandCard(i);
    handEl.appendChild(card);
  });
  document.getElementById('hand-count').textContent = `(${state.hand.length}/7)`;

  // Threat display
  const threatEl = document.getElementById('threat-display');
  if (state.threat) {
    const t = state.threat;
    const hpPct = Math.round((t.hp / t.maxHp) * 100);
    threatEl.innerHTML = `
      <div class="card corruption-card">
        <span class="card-icon">${t.icon}</span>
        <span class="card-name">${t.name}</span>
        <span class="card-desc">${t.desc}</span>
      </div>
      <div class="threat-info">
        HP: <strong>${t.hp}</strong> / ${t.maxHp}<br>
        Damage: <strong>${t.dmg}</strong> corruption<br>
        <span class="threat-timer">Timer: ${'â±'.repeat(t.timer)} (${t.timer} turns)</span>
      </div>
    `;
  } else {
    threatEl.innerHTML = `<p class="threat-info" style="color:var(--success)">Threat neutralized! Brew or end turn to continue.</p>`;
  }

  // Recipe book
  renderRecipeBook();

  // Discard button text
  document.getElementById('discard-btn').textContent = state.discardMode ? `Discard (${state.discardSelected.size})` : 'Discard';

  // Draw button
  const drawBtn = document.getElementById('draw-btn');
  if (state.hand.length >= 7) {
    drawBtn.textContent = 'Hand Full';
    drawBtn.disabled = true;
  } else {
    drawBtn.textContent = state.freeDraw ? 'Draw Cards (free)' : 'Draw Cards (-5 corr.)';
    drawBtn.disabled = false;
  }
}

function renderRecipeBook() {
  const list = document.getElementById('recipe-list');
  list.innerHTML = '';
  const pairs = [];
  for (let i = 0; i < ELEMENTS.length; i++) {
    for (let j = i + 1; j < ELEMENTS.length; j++) {
      pairs.push([ELEMENTS[i], ELEMENTS[j]]);
    }
  }
  pairs.forEach(([a, b]) => {
    const key = recipeKey(a, b);
    const recipe = RECIPES[key];
    const discovered = state.recipesDiscovered.has(key);
    const li = document.createElement('li');
    if (discovered) {
      li.innerHTML = `<span class="recipe-combo">${ELEMENT_DATA[a].icon}+${ELEMENT_DATA[b].icon}</span><span class="recipe-result">${recipe.icon} ${recipe.name}</span>`;
    } else {
      li.innerHTML = `<span class="recipe-combo">${ELEMENT_DATA[a].icon}+${ELEMENT_DATA[b].icon}</span><span class="recipe-undiscovered">???</span>`;
    }
    list.appendChild(li);
  });
}

// â”€â”€ Game Start â”€â”€
function startGame() {
  initState();
  state.deck = buildDeck();
  document.getElementById('title-screen').style.display = 'none';
  document.getElementById('game-container').style.display = 'block';
  document.getElementById('overlay').classList.remove('show');

  addLog('You enter the Corruption Tower...', 'info');
  addLog('Brew potions from ingredient cards to survive!', 'info');

  // Initial draw
  for (let i = 0; i < 5; i++) {
    if (state.deck.length > 0) state.hand.push(state.deck.pop());
  }

  spawnThreat();
  render();
}

function restartGame() {
  document.getElementById('log-entries').innerHTML = '';
  startGame();
}

function toggleInstructions() {
  const overlay = document.getElementById('instructions-overlay');
  overlay.classList.toggle('show');
}
</script>
</body>
</html>
